<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDSFA Fixtures - Leichhardt Saints FC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: white;
            padding: 30px;
            border-bottom: 3px solid #000;
        }

        .header-content {
            width: 100%;
        }

        .header h1 {
            font-size: 2.5em;
            color: #000;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .ground-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .date-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-weight: bold;
            color: #333;
        }

        select, input[type="file"] {
            padding: 8px 12px;
            border: 2px solid #333;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
        }

        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: #DC143C;
        }

        .btn {
            background: #000;
            color: white;
            border: 2px solid #000;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #DC143C;
            border-color: #DC143C;
        }

        .btn:disabled {
            background: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: #000;
            border: 2px solid #000;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #DC143C;
            color: #DC143C;
        }

        .day-section {
            margin: 20px 30px;
        }

        .day-header {
            background: #000;
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fixture-count {
            font-size: 0.8em;
            font-weight: normal;
        }

        .fixture-sheet {
            background: white;
            border: 2px solid #000;
            border-top: none;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .fixture-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .fixture-table th {
            background: #f8f9fa;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            color: #000;
            border-bottom: 2px solid #000;
            border-right: 1px solid #ddd;
            font-size: 14px;
        }

        .fixture-table th:last-child {
            border-right: none;
        }

        .fixture-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            border-right: 1px solid #ddd;
            font-size: 13px;
            color: #333;
        }

        .fixture-table td:last-child {
            border-right: none;
        }

        .fixture-table tr:nth-child(even) {
            background: #fafafa;
        }

        .fixture-table tr:hover {
            background: #f0f0f0;
        }

        .fixture-table tr.highlighted {
            background: #e8e8e8 !important;
        }

        .fixture-table tr.mini-field {
            background: #ffe4e4 !important;
        }

        .fixture-table tr.highlighted.mini-field {
            background: #f5d5d5 !important;
        }

        .round-cell {
            font-weight: bold;
            color: #000;
        }

        .time-cell {
            font-weight: bold;
            color: #000;
        }

        .age-div-cell {
            font-weight: bold;
            color: #000;
        }

        .team-cell {
            font-weight: bold;
            color: #000;
            text-align: left;
            padding-left: 15px;
        }

        .team-cell.lsfc {
            color: #DC143C;
        }

        .field-cell {
            font-weight: bold;
            color: #000;
        }

        .role-cell {
            font-weight: bold;
            color: #DC143C;
        }

        .notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            margin: 20px 30px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }

        .footer-info {
            background: #f8f9fa;
            border-top: 3px solid #000;
            padding: 30px;
            margin-top: 20px;
        }

        .footer-info h3 {
            color: #DC143C;
            font-size: 1.2em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .footer-info p {
            color: #000;
            line-height: 1.6;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .footer-info p.note {
            font-style: italic;
            color: #666;
            font-size: 13px;
        }

        .footer-info strong {
            color: #DC143C;
        }

        .no-data {
            text-align: center;
            padding: 60px 30px;
            color: #666;
            font-size: 18px;
        }

        .stats {
            padding: 15px 30px;
            background: #f8f9fa;
            color: #000;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upload-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
        }

        .upload-section h3 {
            margin-bottom: 10px;
            color: #000;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .fixtures-wrapper {
            display: block;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #f8f9fa;
        }

        .summary-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .summary-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .summary-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .header-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                justify-content: space-between;
            }
            
            .fixture-table {
                font-size: 11px;
            }
            
            .fixture-table th,
            .fixture-table td {
                padding: 8px 5px;
            }
            
            .team-cell {
                padding-left: 8px;
            }

            .stats {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .export-buttons {
                justify-content: center;
            }
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 10mm;
            }

            body {
                background: white;
                padding: 0;
                font-size: 11px;
                line-height: 1.4;
                margin: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
            }

            .upload-section,
            .controls,
            .export-buttons,
            .stats {
                display: none !important;
            }

            .header {
                padding: 0 0 15px 0;
                page-break-after: avoid;
                border-bottom: 2px solid #000;
                margin-bottom: 15px;
            }

            .header h1 {
                font-size: 24px;
                margin-bottom: 10px;
            }

            .header-info {
                font-size: 14px;
            }

            .ground-info,
            .date-info {
                font-size: 14px;
            }

            /* Two column layout for fixtures */
            .fixtures-wrapper {
                display: flex;
                gap: 20px;
                margin-bottom: 15px;
            }

            #saturdaySection,
            #sundaySection {
                display: block !important;
                flex: 1;
                margin: 0;
            }

            .day-section {
                margin: 0;
                page-break-inside: avoid;
            }

            .day-header {
                padding: 10px 15px;
                font-size: 14px;
                background: #000 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .fixture-count {
                font-size: 12px;
            }

            .fixture-sheet {
                border: 1px solid #000;
                border-top: none;
            }

            .fixture-table {
                font-size: 11px;
                width: 100%;
            }

            .fixture-table th {
                padding: 8px 6px;
                font-size: 11px;
                background: #f0f0f0 !important;
                border-bottom: 1px solid #000;
                border-right: 1px solid #ccc;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .fixture-table td {
                padding: 6px 4px;
                font-size: 10px;
                border-bottom: 1px solid #ddd;
                border-right: 1px solid #eee;
                line-height: 1.3;
            }

            .fixture-table tr:nth-child(even) {
                background: #fafafa !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .fixture-table tr.highlighted {
                background: #e8e8e8 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .fixture-table tr.mini-field {
                background: #ffe4e4 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .fixture-table tr.highlighted.mini-field {
                background: #f5d5d5 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .fixture-table tr:hover {
                background: inherit;
            }

            .team-cell {
                padding-left: 8px !important;
                font-size: 10px;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .team-cell.lsfc {
                color: #000 !important;
                font-weight: 900 !important;
            }

            .footer-info {
                padding: 15px 20px;
                page-break-inside: avoid;
                margin-top: auto;
                border-top: 2px solid #000;
                background: #f8f8f8 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .footer-info h3 {
                font-size: 12px;
                margin-bottom: 8px;
                color: #000 !important;
            }

            .footer-info p {
                font-size: 10px;
                margin-bottom: 6px;
                line-height: 1.4;
            }

            .footer-info p.note {
                font-size: 9px;
            }

            .footer-info strong {
                color: #000 !important;
                font-weight: 900;
            }

            .no-data {
                display: none !important;
            }

            /* Hide Role column in print if showing all grounds */
            .hide-in-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Leichhardt Saints FC</h1>
                <div class="header-info">
                    <div class="ground-info" id="selectedGround">All Grounds</div>
                    <div class="date-info" id="dateInfo">No fixtures loaded</div>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <h3>Upload New Fixture File</h3>
            <div class="filter-group">
                <label for="fileUpload">Select Excel File (.xlsx):</label>
                <input type="file" id="fileUpload" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
            </div>
        </div>
        
        <div class="controls">
            <div class="filter-group">
                <label for="groundFilter">Filter by Ground:</label>
                <select id="groundFilter" onchange="filterFixtures()">
                    <option value="">All Grounds</option>
                </select>
            </div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div>Showing <span id="fixtureCount">0</span> fixtures</div>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="printToPDF()">Print to PDF</button>
            </div>
        </div>

        <div class="no-data" id="noData">
            Please upload a fixture file to view fixtures.
        </div>

        <div class="fixtures-wrapper">
            <div id="saturdaySection" style="display: none;">
                <div class="day-section">
                    <div class="day-header">
                        <span id="saturdayDateHeader">Saturday</span>
                        <span class="fixture-count" id="saturdayCount"></span>
                    </div>
                    <div class="fixture-sheet">
                        <table class="fixture-table">
                            <thead>
                                <tr>
                                    <th>Round</th>
                                    <th>Time</th>
                                    <th>Age/Div</th>
                                    <th>Home Team</th>
                                    <th>Away Team</th>
                                    <th>Field</th>
                                    <th>Role</th>
                                </tr>
                            </thead>
                            <tbody id="saturdayBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sundaySection" style="display: none;">
                <div class="day-section">
                    <div class="day-header">
                        <span id="sundayDateHeader">Sunday</span>
                        <span class="fixture-count" id="sundayCount"></span>
                    </div>
                    <div class="fixture-sheet">
                        <table class="fixture-table">
                            <thead>
                                <tr>
                                    <th>Round</th>
                                    <th>Time</th>
                                    <th>Age/Div</th>
                                    <th>Home Team</th>
                                    <th>Away Team</th>
                                    <th>Field</th>
                                    <th>Role</th>
                                </tr>
                            </thead>
                            <tbody id="sundayBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-info">
            <h3>FIELD SET-UP</h3>
            <p>Home teams playing first arrive 30 minutes early to set up the field. When setting up nets, hammer pegs in at an angle for easy removal. Teams playing last on each field pack away equipment. If only one game is scheduled, the same team sets up and packs away.</p>
            <p class="note">Note: Field setup not required at Arlington Oval</p>
            <p><strong>IMPORTANT:</strong> All Saints teams must have a ground official in a fluoro vest at all home games.</p>
            <p><strong>Check Dribl for any late changes to the draw</strong></p>
        </div>
    </div>

    <script>
        let allFixturesData = [];
        let currentFixtures = [];
        let weekendDates = { saturday: null, sunday: null };

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {
                    cellStyles: true,
                    cellFormulas: true,
                    cellDates: true,
                    cellNF: true,
                    sheetStubs: true
                });

                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(worksheet);
                
                allFixturesData = processFixtureData(rawData);
                
                // Detect weekend dates from the data
                detectWeekendDates(allFixturesData);
                
                populateFilters();
                displayFixtures(allFixturesData);
                
                document.getElementById('noData').textContent = `Loaded ${allFixturesData.length} fixtures from uploaded file`;
                
            } catch (error) {
                console.error('Error reading file:', error);
                document.getElementById('noData').textContent = 'Error reading file. Please ensure it is a valid Excel file.';
            }
        }

        function detectWeekendDates(fixtures) {
            // Get all unique dates
            const dates = [...new Set(fixtures.map(f => f.date))].sort();
            
            if (dates.length === 0) {
                weekendDates = { saturday: null, sunday: null };
                updateDateDisplay();
                return;
            }
            
            // Assume first date is Saturday and second is Sunday
            // If only one date, check if it's Saturday or Sunday
            if (dates.length === 1) {
                const date = new Date(dates[0] + 'T00:00:00');
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 6) {
                    weekendDates.saturday = dates[0];
                    weekendDates.sunday = null;
                } else if (dayOfWeek === 0) {
                    weekendDates.saturday = null;
                    weekendDates.sunday = dates[0];
                } else {
                    // Not a weekend day, just assign to Saturday for display
                    weekendDates.saturday = dates[0];
                    weekendDates.sunday = null;
                }
            } else {
                // Multiple dates - take first two
                weekendDates.saturday = dates[0];
                weekendDates.sunday = dates[1];
            }
            
            updateDateDisplay();
        }

        function updateDateDisplay() {
            const dateInfo = document.getElementById('dateInfo');
            const saturdayHeader = document.getElementById('saturdayDateHeader');
            const sundayHeader = document.getElementById('sundayDateHeader');
            
            if (!weekendDates.saturday && !weekendDates.sunday) {
                dateInfo.textContent = 'No fixtures loaded';
                return;
            }
            
            // Format dates for display
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr + 'T00:00:00');
                const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                return date.toLocaleDateString('en-AU', options);
            };
            
            const formatShortDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
            };
            
            // Update header date info
            if (weekendDates.saturday && weekendDates.sunday) {
                const satDate = new Date(weekendDates.saturday + 'T00:00:00');
                const sunDate = new Date(weekendDates.sunday + 'T00:00:00');
                dateInfo.textContent = `${satDate.getDate()}-${sunDate.getDate()} ${satDate.toLocaleDateString('en-AU', { month: 'long', year: 'numeric' })}`;
            } else if (weekendDates.saturday) {
                dateInfo.textContent = formatShortDate(weekendDates.saturday);
            } else if (weekendDates.sunday) {
                dateInfo.textContent = formatShortDate(weekendDates.sunday);
            }
            
            // Update section headers
            if (weekendDates.saturday) {
                saturdayHeader.textContent = formatDate(weekendDates.saturday);
            }
            if (weekendDates.sunday) {
                sundayHeader.textContent = formatDate(weekendDates.sunday);
            }
        }

        function processFixtureData(rawData) {
            return rawData.map(fixture => {
                const dateTimeString = `${fixture.Date} ${fixture.Start}`;
                const venue = fixture.Field ? `${fixture.Ground} - ${fixture.Field}` : fixture.Ground;
                const competition = fixture.League || `${fixture['Age Group']} ${fixture.Division} ${fixture.Gender}`;
                
                return {
                    identifier: fixture.Identifier,
                    datetime: dateTimeString,
                    date: fixture.Date,
                    time: fixture.Start,
                    competition: competition,
                    homeTeam: fixture['Home Team'] || fixture['Home Club Name'],
                    awayTeam: fixture['Away Team'] || fixture['Away Club Name'],
                    venue: venue,
                    ground: fixture.Ground,
                    field: fixture.Field,
                    round: fixture.Round,
                    duration: fixture.Duration,
                    gender: fixture.Gender,
                    ageGroup: fixture['Age Group'],
                    division: fixture.Division,
                    league: fixture.League
                };
            }).filter(fixture => fixture.ground); // Only include fixtures with valid ground
        }

        function populateFilters() {
            // Populate ground filter with only home grounds
            const groundFilter = document.getElementById('groundFilter');
            const homeGrounds = ['Arlington Oval', 'King George Park', 'Balmain Road Sporting Ground', 'Leichhardt Secondary College'];
            
            // Get all unique grounds from data
            const allGrounds = [...new Set(allFixturesData.map(fixture => fixture.ground))];
            
            // Filter to only include home grounds that exist in the data
            const availableHomeGrounds = homeGrounds.filter(ground => 
                allGrounds.some(g => g === ground)
            ).sort();
            
            groundFilter.innerHTML = '<option value="">All Grounds</option>';
            availableHomeGrounds.forEach(ground => {
                const option = document.createElement('option');
                option.value = ground;
                option.textContent = ground;
                groundFilter.appendChild(option);
            });
        }

        function filterFixtures() {
            const groundFilter = document.getElementById('groundFilter').value;
            const selectedGroundDisplay = document.getElementById('selectedGround');
            
            if (groundFilter) {
                currentFixtures = allFixturesData.filter(fixture => fixture.ground === groundFilter);
                selectedGroundDisplay.textContent = groundFilter;
            } else {
                currentFixtures = allFixturesData;
                selectedGroundDisplay.textContent = 'All Grounds';
            }
            
            displayFixtures(currentFixtures);
        }

        function displayFixtures(fixtures) {
            const saturdayBody = document.getElementById('saturdayBody');
            const sundayBody = document.getElementById('sundayBody');
            const saturdaySection = document.getElementById('saturdaySection');
            const sundaySection = document.getElementById('sundaySection');
            const noData = document.getElementById('noData');
            const stats = document.getElementById('stats');
            const fixtureCount = document.getElementById('fixtureCount');
            const groundFilter = document.getElementById('groundFilter').value;
            const isAllGrounds = !groundFilter;

            // Clear existing data
            saturdayBody.innerHTML = '';
            sundayBody.innerHTML = '';

            if (fixtures.length === 0) {
                noData.textContent = 'No fixtures found for the selected ground';
                noData.style.display = 'block';
                saturdaySection.style.display = 'none';
                sundaySection.style.display = 'none';
                stats.style.display = 'none';
                return;
            }

            // Update table headers based on selection
            updateTableHeaders(isAllGrounds);

            // Separate Saturday and Sunday fixtures based on detected dates
            const saturdayFixtures = weekendDates.saturday ? 
                fixtures.filter(fixture => fixture.date === weekendDates.saturday) : [];
            const sundayFixtures = weekendDates.sunday ? 
                fixtures.filter(fixture => fixture.date === weekendDates.sunday) : [];

            // Sort by time
            saturdayFixtures.sort((a, b) => a.time.localeCompare(b.time));
            sundayFixtures.sort((a, b) => a.time.localeCompare(b.time));

            // Calculate roles for each day (only if specific ground selected)
            const saturdayRoles = isAllGrounds ? [] : calculateRoles(saturdayFixtures);
            const sundayRoles = isAllGrounds ? [] : calculateRoles(sundayFixtures);

            // Display Saturday fixtures
            if (saturdayFixtures.length > 0) {
                saturdayFixtures.forEach((fixture, index) => {
                    const row = saturdayBody.insertRow();
                    populateRow(row, fixture, isAllGrounds ? null : saturdayRoles[index]);
                });
                saturdaySection.style.display = 'block';
                document.getElementById('saturdayCount').textContent = `${saturdayFixtures.length} fixtures`;
            } else {
                saturdaySection.style.display = 'none';
            }

            // Display Sunday fixtures
            if (sundayFixtures.length > 0) {
                sundayFixtures.forEach((fixture, index) => {
                    const row = sundayBody.insertRow();
                    populateRow(row, fixture, isAllGrounds ? null : sundayRoles[index]);
                });
                sundaySection.style.display = 'block';
                document.getElementById('sundayCount').textContent = `${sundayFixtures.length} fixtures`;
            } else {
                sundaySection.style.display = 'none';
            }

            // Update stats
            fixtureCount.textContent = fixtures.length;
            stats.style.display = 'flex';
            noData.style.display = 'none';
        }

        function calculateRoles(fixtures) {
            const roles = [];
            const fieldGroups = {};

            // Group fixtures by field
            fixtures.forEach((fixture, index) => {
                const fieldKey = `${fixture.ground}-${fixture.field}`;
                if (!fieldGroups[fieldKey]) {
                    fieldGroups[fieldKey] = [];
                }
                fieldGroups[fieldKey].push({ fixture, index });
            });

            // Initialize all roles as empty
            fixtures.forEach(() => roles.push(''));

            // Calculate roles for each field
            Object.keys(fieldGroups).forEach(fieldKey => {
                const fieldFixtures = fieldGroups[fieldKey];
                const ground = fieldFixtures[0].fixture.ground;

                // Skip Arlington Oval - no setup/pack up needed
                if (ground === 'Arlington Oval') {
                    return;
                }

                // Sort by time to find first and last games
                fieldFixtures.sort((a, b) => a.fixture.time.localeCompare(b.fixture.time));

                if (fieldFixtures.length === 1) {
                    // Single game on this field - both setup and pack up
                    roles[fieldFixtures[0].index] = 'Set up/Pack up';
                } else if (fieldFixtures.length > 1) {
                    // Multiple games - first game setup, last game pack up
                    roles[fieldFixtures[0].index] = 'Set up';
                    roles[fieldFixtures[fieldFixtures.length - 1].index] = 'Pack up';
                }
            });

            return roles;
        }

        function updateTableHeaders(isAllGrounds) {
            // Update Saturday table headers
            const saturdayHeaders = document.querySelector('#saturdaySection thead tr');
            const sundayHeaders = document.querySelector('#sundaySection thead tr');
            
            if (isAllGrounds) {
                // Remove Role column header if it exists
                if (saturdayHeaders.cells.length === 7) {
                    saturdayHeaders.deleteCell(6);
                }
                if (sundayHeaders.cells.length === 7) {
                    sundayHeaders.deleteCell(6);
                }
            } else {
                // Add Role column header if it doesn't exist
                if (saturdayHeaders.cells.length === 6) {
                    const th = document.createElement('th');
                    th.textContent = 'Role';
                    saturdayHeaders.appendChild(th);
                }
                if (sundayHeaders.cells.length === 6) {
                    const th = document.createElement('th');
                    th.textContent = 'Role';
                    sundayHeaders.appendChild(th);
                }
            }
        }

        function populateRow(row, fixture, role) {
            // Format time
            const time = formatTime(fixture.time);

            // Format age/division
            const ageDiv = formatAgeDiv(fixture.ageGroup, fixture.competition, fixture.division);

            // Shorten team names for display
            const homeTeam = shortenTeamName(fixture.homeTeam);
            const awayTeam = shortenTeamName(fixture.awayTeam);

            // Get field name
            const fieldName = fixture.field || 'Field 1';

            // Check if LSFC is involved
            const isLSFCHome = fixture.homeTeam.includes('Leichhardt Saints');
            const isLSFCAway = fixture.awayTeam.includes('Leichhardt Saints');
            const isLSFCInvolved = isLSFCHome || isLSFCAway;

            // Check if it's a mini or half field game
            const isMiniField = fieldName.toLowerCase().includes('mini') || 
                               fieldName.toLowerCase().includes('half') ||
                               fixture.competition.toLowerCase().includes('mini') ||
                               fixture.ageGroup.toLowerCase().includes('mini');

            // Set row classes
            let rowClasses = '';
            if (isLSFCInvolved) rowClasses += 'highlighted ';
            if (isMiniField) rowClasses += 'mini-field ';
            row.className = rowClasses.trim();

            row.innerHTML = `
                <td class="round-cell">R${fixture.round}</td>
                <td class="time-cell">${time}</td>
                <td class="age-div-cell">${ageDiv}</td>
                <td class="team-cell ${isLSFCHome ? 'lsfc' : ''}">${homeTeam}</td>
                <td class="team-cell ${isLSFCAway ? 'lsfc' : ''}">${awayTeam}</td>
                <td class="field-cell">${fieldName}</td>
                ${role !== null ? `<td class="role-cell">${role || ''}</td>` : ''}
            `;
        }

        function formatTime(timeString) {
            // Convert 24-hour to 12-hour format
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'pm' : 'am';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour}:${minutes}${ampm}`;
        }

        function formatAgeDiv(ageGroup, competition, division) {
            // Handle special competitions first
            if (competition.includes('Grace Martin')) {
                return 'GMPL';
            }
            
            // For All Age/Women's competitions
            if (competition.includes('All Age') || competition.includes('WOMEN')) {
                // Use division field if available, otherwise extract from competition
                let div = division;
                if (!div) {
                    const divMatch = competition.match(/(\d+)/);
                    div = divMatch ? divMatch[1] : '1';
                }
                return `Women/${div}`;
            }
            
            // Handle youth competitions
            if (ageGroup) {
                // Extract age number from age group (e.g., "14" from "14 GIRLS" or "U14")
                const ageMatch = ageGroup.match(/(\d+)/);
                const age = ageMatch ? ageMatch[1] : ageGroup;
                
                // Determine gender marker
                const isGirls = ageGroup.includes('GIRLS') || competition.includes('Female') || competition.includes('Girls');
                const genderMarker = isGirls ? 'G' : '';
                
                // Use division field if available, otherwise extract from competition
                let div = division;
                if (!div) {
                    const divMatch = competition.match(/(\d+)/);
                    div = divMatch ? divMatch[1] : '1';
                }
                
                return `U${age}${genderMarker}/${div}`;
            }
            
            // Fallback - try to extract key info from competition string
            return competition.substring(0, 10);
        }

        function shortenTeamName(teamName) {
            // Shorten team names to match PDF format
            return teamName
                .replace('Leichhardt Saints', 'LSFC')
                .replace('Football Club', 'FC')
                .replace('DFC', 'FC')
                .replace('Juniors', 'Jun')
                .replace('University', 'Uni')
                .replace('Secondary College', 'SC')
                .replace('Macquarie', 'Mac')
                .replace('Wanderers', 'Wand')
                .replace('Olympic', 'Oly')
                .replace('Tigers', 'Tig')
                .replace('Lions', 'Lio')
                .replace('Saints', 'LSFC')
                .substring(0, 35); // Limit length
        }

        function printToPDF() {
            window.print();
        }

        // Load XLSX library when page loads
        window.addEventListener('load', () => {
            if (typeof XLSX === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                document.head.appendChild(script);
                script.onload = () => {
                    console.log('XLSX library loaded successfully');
                };
            }
            console.log('Leichhardt Saints FC Fixtures App loaded - Dynamic dates version');
        });
    </script>
</body>
</html>
